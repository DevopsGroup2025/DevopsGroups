---
# Frontend Role - Next.js Application

- name: Install required packages
  become: yes
  yum:
    name:
      - rsync
    state: present

- name: Remove NodeSource repositories if present
  become: yes
  shell: |
    rm -f /etc/yum.repos.d/nodesource*.repo
    yum clean all
  changed_when: false

- name: Install development tools for Node.js
  become: yes
  yum:
    name:
      - gcc-c++
      - make
    state: present

- name: Install NVM as ec2-user
  become: yes
  become_user: ec2-user
  shell: |
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
  args:
    creates: /home/ec2-user/.nvm/nvm.sh

- name: Install Node.js 16 (LTS) using NVM
  become: yes
  become_user: ec2-user
  shell: |
    . ~/.nvm/nvm.sh
    nvm install 16
    nvm alias default 16
  args:
    executable: /bin/bash
    creates: /home/ec2-user/.nvm/versions/node/v16*

- name: Verify Node.js installation
  become: yes
  become_user: ec2-user
  shell: |
    . ~/.nvm/nvm.sh
    node --version
  args:
    executable: /bin/bash
  register: node_version
  changed_when: false

- name: Display Node.js version
  debug:
    msg: "Node.js version: {{ node_version.stdout }}"

- name: Install PM2 globally
  become: yes
  become_user: ec2-user
  shell: |
    . ~/.nvm/nvm.sh
    npm install -g pm2
  args:
    executable: /bin/bash

- name: Create application directory
  become: yes
  file:
    path: "{{ app_dir }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'

- name: Copy frontend application
  synchronize:
    src: "{{ playbook_dir }}/../apps/frontend/"
    dest: "{{ app_dir }}/"
    delete: no
    recursive: yes
    rsync_opts:
      - "--exclude=node_modules"
      - "--exclude=.next"
      - "--exclude=.env.local"
  notify: Restart frontend service

- name: Create .env.local file from template
  template:
    src: env.local.j2
    dest: "{{ app_dir }}/.env.local"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0644'
  notify: Restart frontend service

- name: Install npm dependencies
  become: yes
  become_user: ec2-user
  shell: |
    . ~/.nvm/nvm.sh
    npm install
  args:
    chdir: "{{ app_dir }}"
    executable: /bin/bash

- name: Build Next.js application
  become: yes
  become_user: ec2-user
  shell: |
    . ~/.nvm/nvm.sh
    npm run build
  args:
    chdir: "{{ app_dir }}"
    executable: /bin/bash
  register: build_result
  changed_when: build_result.rc == 0

- name: Configure PM2 to start on boot
  become: yes
  shell: |
    . /home/ec2-user/.nvm/nvm.sh
    env PATH=$PATH:$(dirname $(which node)) pm2 startup systemd -u ec2-user --hp /home/ec2-user
  args:
    creates: /etc/systemd/system/pm2-ec2-user.service
    executable: /bin/bash

- name: Start application with PM2
  become: yes
  become_user: ec2-user
  shell: |
    . ~/.nvm/nvm.sh
    pm2 delete frontend || true
    pm2 start npm --name frontend -- start
    pm2 save
  args:
    chdir: "{{ app_dir }}"
    executable: /bin/bash
  register: pm2_start
  changed_when: "'online' in pm2_start.stdout or 'spawned' in pm2_start.stdout"

- name: Ensure PM2 service is enabled and started
  become: yes
  systemd:
    name: pm2-{{ ansible_user }}
    enabled: yes
    state: started

- name: Display frontend URL
  debug:
    msg: "Frontend application is running at http://{{ inventory_hostname }}:{{ frontend_port }}"

- name: Configure Nginx reverse proxy
  include_tasks: nginx.yml
  tags: nginx
