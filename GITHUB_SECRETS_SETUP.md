# GitHub Secrets and Variables Setup

This document describes how to configure GitHub Secrets and Variables for the CI/CD pipeline.

## Overview

The CI/CD pipeline requires:
- **Secrets** - Sensitive data that should never be exposed (keys, passwords)
- **Variables** - Configuration values that vary by environment (IPs, endpoints)

## Required GitHub Secrets

Navigate to: `Repository → Settings → Secrets and variables → Actions → Secrets`

### AWS Credentials

| Secret Name | Description | Required |
|-------------|-------------|----------|
| `AWS_ACCESS_KEY_ID` | AWS IAM access key ID | Yes |
| `AWS_SECRET_ACCESS_KEY` | AWS IAM secret access key | Yes |
| `AWS_SESSION_TOKEN` | AWS session token for temporary credentials | Yes (if using AWS Academy/temporary creds) |

**Important:** The AWS credentials must have permissions to:
- Push images to ECR
- Describe ECR repositories
- Get ECR authorization token

### Required IAM Policy for ECR Push

Your AWS user/role needs this policy attached:

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "ECRPushPull",
            "Effect": "Allow",
            "Action": [
                "ecr:GetAuthorizationToken",
                "ecr:BatchCheckLayerAvailability",
                "ecr:GetDownloadUrlForLayer",
                "ecr:BatchGetImage",
                "ecr:PutImage",
                "ecr:InitiateLayerUpload",
                "ecr:UploadLayerPart",
                "ecr:CompleteLayerUpload",
                "ecr:DescribeRepositories",
                "ecr:ListImages"
            ],
            "Resource": "*"
        }
    ]
}
```

**For AWS Academy/Lab accounts:** The `LabRole` or `voclabs` role typically already has ECR permissions. Just use the credentials from the AWS Details page.

### SSH Key

| Secret Name | Description | How to Get |
|-------------|-------------|------------|
| `SSH_PRIVATE_KEY` | SSH private key for EC2 access | See instructions below |

**How to add SSH_PRIVATE_KEY:**

1. Open the private key file generated by Terraform:
   ```
   ansible/keys/terraform-ansible-webapp-key.pem
   ```

2. Copy the entire contents including:
   ```
   -----BEGIN RSA PRIVATE KEY-----
   ... (key content) ...
   -----END RSA PRIVATE KEY-----
   ```

3. Go to GitHub → Repository → Settings → Secrets → Actions
4. Click "New repository secret"
5. Name: `SSH_PRIVATE_KEY`
6. Value: Paste the entire key content
7. Click "Add secret"

### Database Password

| Secret Name | Description | Example |
|-------------|-------------|---------|
| `DB_PASSWORD` | RDS database password | Your database password from `terraform.tfvars` |

## Required GitHub Variables

Navigate to: `Repository → Settings → Secrets and variables → Actions → Variables`

### AWS Configuration

| Variable Name | Description | Current Value |
|---------------|-------------|---------------|
| `AWS_REGION` | AWS region | `eu-west-1` |
| `AWS_ACCOUNT_ID` | AWS account ID | `904570587823` |

### Infrastructure IPs (from Terraform Output)

| Variable Name | Description | Current Value |
|---------------|-------------|---------------|
| `BASTION_IP` | Bastion host public IP | `34.240.179.214` |
| `FRONTEND_IP` | Frontend private IP | `10.0.10.93` |
| `BACKEND_IP` | Backend private IP | `10.0.11.60` |
| `DB_HOST` | RDS database endpoint | `terraform-ansible-webapp-db.c9awcwiy8psk.eu-west-1.rds.amazonaws.com` |

## Step-by-Step Setup

### 1. Add Secrets

```bash
# Using GitHub CLI (optional)
gh secret set AWS_ACCESS_KEY_ID
gh secret set AWS_SECRET_ACCESS_KEY
gh secret set SSH_PRIVATE_KEY < ansible/keys/terraform-ansible-webapp-key.pem
gh secret set DB_PASSWORD
```

Or via GitHub Web UI:
1. Go to repository settings
2. Click "Secrets and variables" → "Actions"
3. Click "New repository secret"
4. Add each secret

### 2. Add Variables

```bash
# Using GitHub CLI (optional)
gh variable set AWS_REGION --body "eu-west-1"
gh variable set AWS_ACCOUNT_ID --body "904570587823"
gh variable set BASTION_IP --body "34.240.179.214"
gh variable set FRONTEND_IP --body "10.0.10.93"
gh variable set BACKEND_IP --body "10.0.11.60"
gh variable set DB_HOST --body "terraform-ansible-webapp-db.c9awcwiy8psk.eu-west-1.rds.amazonaws.com"
```

Or via GitHub Web UI:
1. Go to repository settings
2. Click "Secrets and variables" → "Actions" → "Variables" tab
3. Click "New repository variable"
4. Add each variable

### 3. Create Environment (Optional)

For production deployments with approval gates:

1. Go to Settings → Environments
2. Click "New environment"
3. Name: `production`
4. Add protection rules:
   - Required reviewers
   - Wait timer
5. Add environment-specific secrets if needed

## Getting Values from Terraform

After running `terraform apply`, get the required values:

```bash
cd terraform

# Get all outputs
terraform output

# Get specific values
terraform output bastion_public_ip
terraform output frontend_private_ip
terraform output backend_private_ip
terraform output database_address
terraform output ecr_registry_url
```

## Verifying Setup

Run this command to check if secrets are set (names only, not values):

```bash
gh secret list
gh variable list
```

## Security Best Practices

1. **Never commit secrets** to the repository
2. **Rotate credentials** periodically
3. **Use least privilege** IAM policies
4. **Enable MFA** for AWS account
5. **Use temporary credentials** when possible (AWS_SESSION_TOKEN)
6. **Restrict IP access** in security groups for production

## Troubleshooting

### "Permission denied (publickey)"
- Check that `SSH_PRIVATE_KEY` is correctly set
- Verify the key includes the full content with headers

### "Unable to locate credentials"
- Verify `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY` are set
- Check IAM permissions include ECR access

### "Connection timeout"
- Verify `BASTION_IP`, `FRONTEND_IP`, `BACKEND_IP` are correct
- Check security groups allow the connections
- Ensure NAT Gateway is enabled for private instances

## Quick Reference - Current Values

After your Terraform deployment, these are your current values:

### GitHub Variables (Repository Settings → Secrets and variables → Actions → Variables tab)

| Variable | Value |
|----------|-------|
| `AWS_REGION` | `eu-west-1` |
| `AWS_ACCOUNT_ID` | `904570587823` |
| `BASTION_IP` | `34.240.179.214` |
| `FRONTEND_IP` | `10.0.10.93` |
| `BACKEND_IP` | `10.0.11.60` |
| `DB_HOST` | `terraform-ansible-webapp-db.c9awcwiy8psk.eu-west-1.rds.amazonaws.com` |

### GitHub Secrets (Repository Settings → Secrets and variables → Actions → Secrets tab)

| Secret | Where to get it |
|--------|-----------------|
| `AWS_ACCESS_KEY_ID` | From AWS Console → IAM → Your User → Security Credentials, or AWS Academy "AWS Details" |
| `AWS_SECRET_ACCESS_KEY` | Same as above |
| `AWS_SESSION_TOKEN` | AWS Academy "AWS Details" → "Show" next to AWS CLI credentials |
| `SSH_PRIVATE_KEY` | Contents of `ansible/keys/terraform-ansible-webapp-key.pem` |
| `DB_PASSWORD` | Your database password from `terraform.tfvars` |

### Getting AWS Credentials (AWS Academy)

1. Go to your AWS Academy Lab
2. Click "AWS Details" 
3. Click "Show" next to "AWS CLI"
4. Copy these values:
   - `aws_access_key_id` → `AWS_ACCESS_KEY_ID` secret
   - `aws_secret_access_key` → `AWS_SECRET_ACCESS_KEY` secret
   - `aws_session_token` → `AWS_SESSION_TOKEN` secret

**Note:** AWS Academy session tokens expire every ~4 hours. You'll need to update them when they expire.
